<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Minna no Nihongo ‚Äì Quiz T·ª´ v·ª±ng (50 b√†i)</title>
  <style>
    :root { --gap: 14px; --radius: 14px; }
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji"; margin: 0; background: #f7f7fb; color: #222; }
    header { padding: 14px 18px; background: white; position: sticky; top: 0; z-index: 10; border-bottom: 1px solid #eee; }
    .wrap { max-width: 1100px; margin: 0 auto; }
    .h-row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .brand { font-weight: 800; font-size: 16px; margin-right: 8px; }
    .muted { color:#666; font-size: 12px; }

    .btn { padding: 10px 12px; border-radius: 10px; font-size: 14px; border:1px solid #ddd; background:#fff; cursor:pointer; }
    .btn.primary { background:#111827; color:#fff; border-color:#111827; }
    .btn.alt { background:#2563eb; color:#fff; border-color:#2563eb; }
    .btn.ghost { background: transparent; color:#111; }
    .chip { padding:8px 10px; border:1px solid #e5e7eb; border-radius: 10px; background:#f8fafc; }
    .sep { width:1px; height:28px; background:#eee; }

    main { padding: 16px 18px; }
    .layout { display:grid; gap: var(--gap); grid-template-columns: 1fr; }
    @media (min-width: 980px){ .layout { grid-template-columns: 1fr; } }

    .panel { background: white; border: 1px solid #eee; border-radius: var(--radius); padding: 12px; box-shadow: 0 1px 0 rgba(0,0,0,.04); }
    .controls { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }

    /* Dropdown multi-select */
    .dd { position: relative; }
    .dd-btn { display:flex; align-items:center; gap:8px; }
    .dd-menu { position:absolute; top:calc(100% + 8px); left:0; min-width: 280px; max-height: 320px; overflow:auto; background:#fff; border:1px solid #eee; border-radius: 12px; box-shadow: 0 12px 30px rgba(0,0,0,.08); padding:8px; z-index: 20; display:none; }
    .dd.open .dd-menu { display:block; }
    .dd-actions { display:flex; gap:8px; padding:6px; border-bottom:1px dashed #eee; margin-bottom:6px; }
    .dd-list { display:grid; grid-template-columns: 1fr 1fr 1fr; gap:6px; }
    .dd-item { display:flex; align-items:center; gap:6px; padding:6px 8px; border:1px solid #f0f0f0; border-radius:8px; }

    /* Quiz area fixed with its own scroll */
    .quiz-shell { height: 72vh; display:grid; grid-template-rows: auto 1fr auto; gap:10px; }
    .quiz-scroll { overflow:auto; padding-right: 4px; }
    .card { border:1px solid #eee; border-radius: var(--radius); padding: 14px; display:grid; gap:10px; background:#fff; }
    .q-head { font-weight: 700; }
    .answer { display:flex; gap:10px; align-items:center; flex-wrap: wrap; }
    input[type="text"], input[type="number"] { padding: 10px 12px; border:1px solid #ddd; border-radius:10px; font-size:14px; }
    .pill { font-size: 12px; padding: 4px 8px; background:#f1f5f9; border-radius:999px; border:1px solid #e5e7eb; }
    .ok { background:#e6f7eb; border-color:#b7eb8f; color:#096; }
    .bad { background:#fff1f0; border-color:#ffa39e; color:#a8071a; }

    /* Modal */
    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,.24); display:none; align-items:center; justify-content:center; z-index: 50; }
    .modal { width: min(720px, 92vw); background:#fff; border-radius:16px; border:1px solid #eee; box-shadow: 0 24px 60px rgba(0,0,0,.18); overflow:hidden; }
    .modal header { position:relative; border-bottom:1px solid #f0f0f0; }
    .modal .content { padding:16px; display:grid; gap:10px; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap: wrap; }
    textarea { width:100%; border:1px solid #ddd; border-radius:10px; padding:10px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }

    .footer { margin-top: 12px; font-size: 12px; color:#555; }
  </style>
</head>
<body>
  <!-- Header -->
  <header>
    <div class="wrap">
      <div class="h-row">
        <div class="brand">Minna no Nihongo ‚Äì Luy·ªán t·ª´ v·ª±ng</div>
        <span class="muted">T·∫°o ƒë·ªÅ ‚Ä¢ nh·∫≠p ƒë√°p √°n b·∫±ng <b>hiragana/katakana</b> (kh√¥ng kanji)</span>
      </div>

      <!-- Controls pinned on header -->
      <div class="h-row" style="margin-top:10px">
        <!-- Data modal trigger -->
        <button class="btn" id="btnData">N·∫°p / Qu·∫£n l√Ω d·ªØ li·ªáu</button>
        <span class="chip" id="dataInfo">Ch∆∞a c√≥ d·ªØ li·ªáu</span>

        <div class="sep"></div>

        <!-- Multi-select lessons -->
        <div class="dd" id="lessonDD">
          <button class="btn dd-btn" id="lessonBtn">Ch·ªçn b√†i (0)</button>
          <div class="dd-menu panel">
            <div class="dd-actions">
              <button class="btn" id="checkAll">Ch·ªçn t·∫•t c·∫£</button>
              <button class="btn" id="uncheckAll">B·ªè ch·ªçn</button>
              <span class="muted" id="countPick">0 b√†i</span>
            </div>
            <div class="dd-list" id="lessonList"></div>
          </div>
        </div>

        <div class="sep"></div>

        <!-- Quiz options -->
        <label class="chip">
          H∆∞·ªõng: <input type="checkbox" id="direction" style="margin-left:6px"/>
          <span class="muted"> &nbsp;Vi·ªát ‚Üí Nh·∫≠t</span>
        </label>
        <label class="chip"><input type="checkbox" id="furigana" /> &nbsp;Hi·ªán Kanji trong ƒë·ªÅ</label>
        <label class="chip"><input type="checkbox" id="shuffle" checked/> &nbsp;X√°o tr·ªôn</label>
        <label class="chip">S·ªë c√¢u: <input type="number" id="numQ" min="1" step="1" value="10" style="width:90px; margin-left:6px"/></label>

        <div class="sep"></div>

        <button class="btn primary" id="makeQuiz">L√†m b√†i</button>
        <button class="btn" id="clearQuiz">X√≥a ƒë·ªÅ</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <!-- Quiz fixed shell -->
    <section class="panel quiz-shell" id="quizShell" style="display:none">
      <div class="h-row" id="quizToolbar" style="justify-content:space-between">
        <div class="h-row">
          <div id="scoreBox" class="chip">ƒêi·ªÉm: <b id="scoreNow">0</b>/<span id="scoreMax">0</span></div>
          <div class="chip">ƒê√£ l√†m: <b id="doneNow">0</b>/<span id="doneMax">0</span></div>
        </div>
        <div class="h-row">
          <button class="btn alt" id="submitQuiz">Submit</button>
          <button class="btn" id="retryWrong" style="display:none">L√†m l·∫°i c√¢u sai</button>
          <button class="btn" id="retryAll" style="display:none">L√†m l·∫°i t·∫•t c·∫£</button>
        </div>
      </div>

      <div class="quiz-scroll" id="quiz"></div>

      <div class="footer">
        Ngu·ªìn tham kh·∫£o d·ªØ li·ªáu: VNJPClub ‚Äì Minna no Nihongo 1‚Äì50. D√πng cho m·ª•c ƒë√≠ch h·ªçc c√° nh√¢n.
      </div>
    </section>
  </main>

  <!-- Data Modal -->
  <div class="modal-backdrop" id="modalData">
    <div class="modal">
      <header style="padding:12px 16px; background:#fff">
        <div class="h-row" style="justify-content:space-between">
          <div><b>Qu·∫£n l√Ω d·ªØ li·ªáu 50 b√†i</b></div>
          <button class="btn" id="closeModal">ƒê√≥ng</button>
        </div>
      </header>
      <div class="content">
        <div class="panel">
          <div class="row">
            <label for="fileInput"><b>N·∫°p t·ª´ file JSON:</b></label>
            <input type="file" id="fileInput" accept=".json" />
            <button class="btn" id="clearData">X√≥a d·ªØ li·ªáu ƒë√£ n·∫°p</button>
          </div>
        </div>
        <div class="panel">
          <p class="muted">Ho·∫∑c d√°n JSON v√†o √¥ d∆∞·ªõi (c·∫•u tr√∫c: {"1":[{"jp":"„Çè„Åü„Åó","kanji":"ÁßÅ","vn":"t√¥i"}, ...]})</p>
          <textarea id="jsonInput" rows="10" placeholder='{"1":[{"jp":"...", "kanji":"...", "vn":"..."}]}'></textarea>
          <div class="row">
            <button class="btn alt" id="loadJson">N·∫°p d·ªØ li·ªáu</button>
            <button class="btn" id="downloadJson">T·∫£i JSON hi·ªán t·∫°i</button>
          </div>
        </div>
      </div>
    </div>
  </div>

 <script>
  // ====== D·ªÆ LI·ªÜU trong b·ªô nh·ªõ (n·∫°p t·ª´ file/textarea) ======
  const DATA = {}; // { "1": [ {jp, kanji?, vn}, ... ], ... }
  const STORAGE_KEY = "minna_vocab_v1"; // üî• kh√≥a l∆∞u localStorage

  // ====== DOM ======
  const dataInfo = document.getElementById('dataInfo');

  const lessonDD = document.getElementById('lessonDD');
  const lessonBtn = document.getElementById('lessonBtn');
  const lessonList = document.getElementById('lessonList');
  const countPick = document.getElementById('countPick');

  const numQ = document.getElementById('numQ');
  const shuffleCB = document.getElementById('shuffle');
  const directionCB = document.getElementById('direction');
  const furiganaCB = document.getElementById('furigana');

  const quizShell = document.getElementById('quizShell');
  const quizEl = document.getElementById('quiz');
  const scoreNow = document.getElementById('scoreNow');
  const scoreMax = document.getElementById('scoreMax');
  const doneNow = document.getElementById('doneNow');
  const doneMax = document.getElementById('doneMax');

  const submitQuizBtn = document.getElementById('submitQuiz');
  const retryWrongBtn = document.getElementById('retryWrong');
  const retryAllBtn = document.getElementById('retryAll');

  // Modal
  const modal = document.getElementById('modalData');
  const btnData = document.getElementById('btnData');
  const closeModal = document.getElementById('closeModal');
  const fileInput = document.getElementById('fileInput');
  const jsonInput = document.getElementById('jsonInput');

  // Buttons header
  const makeQuizBtn = document.getElementById('makeQuiz');
  const clearQuizBtn = document.getElementById('clearQuiz');
  const checkAllBtn = document.getElementById('checkAll');
  const uncheckAllBtn = document.getElementById('uncheckAll');

  // Data actions
  const loadJsonBtn = document.getElementById('loadJson');
  const downloadJsonBtn = document.getElementById('downloadJson');
  const clearDataBtn = document.getElementById('clearData');

  // ====== Utils ======
  const shuffleArr = (arr)=> arr.map(v=>[Math.random(), v]).sort((a,b)=>a[0]-b[0]).map(x=>x[1]);
  const normalize = (s)=> (s||"").trim().replace(/\s+/g,'').toLowerCase();

  function openModal(){ modal.style.display = 'flex'; }
  function closeModalFn(){ modal.style.display = 'none'; }

  btnData.addEventListener('click', openModal);
  closeModal.addEventListener('click', closeModalFn);
  modal.addEventListener('click', (e)=>{ if (e.target === modal) closeModalFn(); });

  // ====== Lessons UI ======
  function refreshLessonOptions(){
    lessonList.innerHTML = '';
    const keys = Object.keys(DATA).map(k=>Number(k)).sort((a,b)=>a-b);
    dataInfo.textContent = keys.length ? `ƒê√£ n·∫°p: ${keys.length} b√†i` : 'Ch∆∞a c√≥ d·ªØ li·ªáu';
    if (!keys.length){
      lessonBtn.textContent = 'Ch·ªçn b√†i (0)';
      countPick.textContent = '0 b√†i';
      return;
    }
    for (const k of keys){
      const id = `L${k}`;
      const item = document.createElement('label');
      item.className = 'dd-item';
      item.innerHTML = `<input type="checkbox" value="${k}" id="${id}"><span>B√†i ${k}</span>`;
      lessonList.appendChild(item);
    }
    updateLessonCount();
  }

  function getSelectedLessons(){
    return Array.from(lessonList.querySelectorAll('input[type=checkbox]:checked')).map(i=>i.value);
  }
  function setAllLessons(checked){
    lessonList.querySelectorAll('input[type=checkbox]').forEach(i=> i.checked = checked);
    updateLessonCount();
  }
  function updateLessonCount(){
    const n = getSelectedLessons().length;
    lessonBtn.textContent = `Ch·ªçn b√†i (${n})`;
    countPick.textContent = `${n} b√†i`;
  }

  lessonBtn.addEventListener('click', ()=>{
    lessonDD.classList.toggle('open');
  });
  document.addEventListener('click', (e)=>{
    if (!lessonDD.contains(e.target)) lessonDD.classList.remove('open');
  });
  lessonList.addEventListener('change', updateLessonCount);
  checkAllBtn.addEventListener('click', ()=> setAllLessons(true));
  uncheckAllBtn.addEventListener('click', ()=> setAllLessons(false));

  // ====== LocalStorage helpers ======
  function saveToLocal(){
    try { localStorage.setItem(STORAGE_KEY, JSON.stringify(DATA)); }
    catch(e){ console.warn('L∆∞u localStorage l·ªói:', e); }
  }
  function loadFromLocal(){
    try {
      const s = localStorage.getItem(STORAGE_KEY);
      if (!s) return;
      const obj = JSON.parse(s);
      for (const k of Object.keys(obj)) DATA[k] = obj[k];
    } catch(e){ console.warn('ƒê·ªçc localStorage l·ªói:', e); }
  }
  function clearLocal(){
    try { localStorage.removeItem(STORAGE_KEY); } catch{}
  }

  // ====== Data merge / load ======
  function mergeData(obj){
    let added = 0;
    for (const k of Object.keys(obj)){
      DATA[k] = obj[k];
      added++;
    }
    refreshLessonOptions();
    saveToLocal(); // üî• l∆∞u ngay sau khi n·∫°p
    alert('ƒê√£ n·∫°p d·ªØ li·ªáu' + (added ? `: ${added} nh√≥m` : ''));
  }

  fileInput.addEventListener('change', function(){
    const f = this.files[0]; if(!f) return;
    const reader = new FileReader();
    reader.onload = (e)=>{
      try { const obj = JSON.parse(e.target.result); mergeData(obj); }
      catch(err){ alert('File JSON kh√¥ng h·ª£p l·ªá: ' + err.message); }
    };
    reader.readAsText(f, 'utf-8');
  });

  loadJsonBtn.onclick = () => {
    try { const obj = JSON.parse(jsonInput.value); mergeData(obj); }
    catch (e) { alert('JSON kh√¥ng h·ª£p l·ªá: ' + e.message); }
  };

  downloadJsonBtn.onclick = () => {
    const blob = new Blob([JSON.stringify(DATA, null, 2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'minna50_vocab.json';
    a.click();
    URL.revokeObjectURL(a.href);
  };

  clearDataBtn.onclick = () => {
    for (const k of Object.keys(DATA)) delete DATA[k];
    refreshLessonOptions();
    clearLocal(); // üî• x√≥a lu√¥n d·ªØ li·ªáu ƒë√£ l∆∞u
    alert('ƒê√£ x√≥a d·ªØ li·ªáu trong b·ªô nh·ªõ.');
  };

  // ====== Build quiz pool ======
  function collectSelectedData() {
    const opts = getSelectedLessons();
    const pool = [];
    for (const L of opts) if (DATA[L]) pool.push(...DATA[L].map(x=> ({...x, lesson: Number(L)})));
    return pool;
  }

  // ====== Quiz lifecycle ======
  let currentPicked = []; // store picked questions for submit/retry
  let askVN = true;

  function renderQuiz(picked){
    quizEl.innerHTML = '';
    const N = picked.length;
    scoreNow.textContent = '0';
    scoreMax.textContent = String(N);
    doneNow.textContent = '0';
    doneMax.textContent = String(N);
    let doneCount = 0;

    picked.forEach((it, idx) => {
      const card = document.createElement('div'); card.className = 'card';
      const head = document.createElement('div'); head.className = 'q-head';
      const qTxt = askVN ? it.vn : (furiganaCB.checked && it.kanji ? `${it.jp}Ôºà${it.kanji}Ôºâ` : it.jp);
      head.textContent = `${idx+1}. ${qTxt}`; card.appendChild(head);

      const ans = document.createElement('div'); ans.className = 'answer';
      const input = document.createElement('input'); input.type = 'text';
      input.placeholder = askVN ? 'Nh·∫≠p ti·∫øng Nh·∫≠t (hiragana/katakana)' : 'Nh·∫≠p nghƒ©a ti·∫øng Vi·ªát';
      input.autocomplete = 'off'; input.spellcheck = false; input.dataset.correct = askVN ? it.jp : it.vn;

      const tag = document.createElement('span'); tag.className = 'pill'; tag.textContent = `B√†i ${it.lesson}`;
      const status = document.createElement('span'); status.className = 'pill'; status.textContent = 'Ch∆∞a ch·∫•m';

      // ƒë·∫øm ƒë√£ tr·∫£ l·ªùi (ch∆∞a ch·∫•m) ƒë·ªÉ hi·ªÉn th·ªã "ƒê√£ l√†m"
      input.addEventListener('input', ()=>{
        const had = input.dataset._typed === '1';
        const has = !!input.value.trim();
        if (!had && has){ doneCount++; input.dataset._typed = '1'; }
        else if (had && !has){ doneCount--; input.dataset._typed = '0'; }
        doneNow.textContent = String(doneCount);
      });

      ans.appendChild(input); ans.appendChild(tag); ans.appendChild(status);
      card.appendChild(ans);

      const reveal = document.createElement('div'); reveal.className = 'muted';
      reveal.style.display = 'none';
      reveal.innerHTML = askVN
        ? `ƒê√°p √°n: <b>${it.jp}</b>${it.kanji ? `Ôºà${it.kanji}Ôºâ` : ''}`
        : `ƒê√°p √°n: <b>${it.vn}</b>`;
      card.appendChild(reveal);

      quizEl.appendChild(card);
    });
  }

  // ‚úÖ ch·ªâ ch·∫•p nh·∫≠n kana khi Vi·ªát ‚Üí Nh·∫≠t
// ‚úÖ cho ph√©p kana + kanji
function isJapaneseOnly(s){
  // Hiragana 3040-309F, Katakana 30A0-30FF, Halfwidth Katakana FF65-FF9F,
  // Kanji c∆° b·∫£n 4E00-9FFF, d√†i √¢m 30FC, ch·∫•m gi·ªØa 30FB, kho·∫£ng tr·∫Øng
  const re = /^[\u3040-\u309F\u30A0-\u30FF\uFF65-\uFF9F\u4E00-\u9FFF\u30FC\u30FB\s]+$/;
  return re.test(s);
}

function gradeQuiz(){
  const inputs = Array.from(quizEl.querySelectorAll('input[type=text]'));
  let correctCount = 0;
  inputs.forEach(inp=>{
    const raw = inp.value.trim();
    const user = normalize(raw);
    const corr = normalize(inp.dataset.correct);
    const status = inp.parentElement.querySelector('.pill:last-child');
    const reveal = inp.closest('.card').querySelector('.muted');

    // N·∫øu ƒëang Vi·ªát ‚Üí Nh·∫≠t th√¨ b·∫Øt bu·ªôc k√Ω t·ª± Nh·∫≠t (kana ho·∫∑c kanji)
    if (directionCB.checked && raw && !isJapaneseOnly(raw)){
      status.textContent = 'Kh√¥ng h·ª£p l·ªá: ch·ªâ ch·ªØ Nh·∫≠t';
      status.className = 'pill bad';
      reveal.style.display = '';
      inp.disabled = true;
      return;
    }

    const ok = user && user === corr;
    if (ok){ correctCount++; status.textContent = 'ƒê√∫ng'; status.className = 'pill ok'; }
    else { status.textContent = user ? 'Sai' : 'Ch∆∞a tr·∫£ l·ªùi'; status.className = 'pill bad'; }

    reveal.style.display = '';
    inp.disabled = true;
  });
  scoreNow.textContent = String(correctCount);
  retryWrongBtn.style.display = 'inline-block';
  retryAllBtn.style.display = 'inline-block';
}


  function makeQuiz(){
    let pool = collectSelectedData();
    if (pool.length === 0) {
      alert('Ch∆∞a c√≥ d·ªØ li·ªáu cho b√†i ƒë√£ ch·ªçn. H√£y n·∫°p JSON tr∆∞·ªõc.');
      return;
    }
    if (shuffleCB.checked) pool = shuffleArr(pool);
    const N = Math.max(1, Math.min(pool.length, parseInt(numQ.value || '10', 10)));
    askVN = directionCB.checked;
    currentPicked = pool.slice(0, N);
    quizShell.style.display = '';
    retryWrongBtn.style.display = 'none';
    retryAllBtn.style.display = 'none';
    renderQuiz(currentPicked);
  }

  

  function retryWrong(){
    const cards = Array.from(quizEl.querySelectorAll('.card'));
    const wrong = [];
    cards.forEach((card, i)=>{
      const status = card.querySelector('.pill:last-child');
      if (!status.classList.contains('ok')) wrong.push(currentPicked[i]);
    });
    if (!wrong.length){ alert('B·∫°n kh√¥ng c√≤n c√¢u sai üéâ'); return; }
    currentPicked = shuffleArr(wrong);
    renderQuiz(currentPicked);
    retryWrongBtn.style.display = 'none';
    retryAllBtn.style.display = 'none';
  }

  function retryAll(){
    currentPicked = shuffleArr(currentPicked);
    renderQuiz(currentPicked);
    retryWrongBtn.style.display = 'none';
    retryAllBtn.style.display = 'none';
  }

  // ====== Events ======
  makeQuizBtn.addEventListener('click', makeQuiz);
  clearQuizBtn.addEventListener('click', ()=>{ quizEl.innerHTML=''; quizShell.style.display='none'; });
  submitQuizBtn.addEventListener('click', gradeQuiz);
  retryWrongBtn.addEventListener('click', retryWrong);
  retryAllBtn.addEventListener('click', retryAll);

  // ====== Kh·ªüi ƒë·ªông: kh√¥i ph·ª•c d·ªØ li·ªáu ƒë√£ l∆∞u (n·∫øu c√≥) ======
  window.addEventListener('DOMContentLoaded', ()=>{
    loadFromLocal();        // üî• kh√¥i ph·ª•c
    refreshLessonOptions(); // v·∫Ω l·∫°i danh s√°ch b√†i
  });
</script>
