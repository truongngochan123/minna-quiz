<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Minna no Nihongo ‚Äì Quiz T·ª´ v·ª±ng (50 b√†i)</title>
  <style>
:root {
  --radius: 14px;
  --gap: 14px;
  --primary: #2563eb;
  --accent: #9333ea;
  --bg: #f3f4f6;
  --text: #1e293b;
  --muted: #6b7280;
  --success: #22c55e;
  --danger: #ef4444;
  --card-bg: #ffffff;
  --shadow: 0 4px 20px rgba(0,0,0,0.05);
  --shadow-strong: 0 10px 25px rgba(0,0,0,0.15);
}

/* Reset & base */
* { box-sizing: border-box; transition: all .15s ease; }
html, body { margin:0; padding:0; font-family: "Inter", "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text); }

/* Header */
header {
  padding: 14px 18px;
  background: linear-gradient(90deg, var(--primary), var(--accent));
  color: #fff;
  position: sticky;
  top: 0; z-index: 10;
  box-shadow: var(--shadow-strong);
}
.brand {
  font-weight: 800;
  font-size: 17px;
  letter-spacing: 0.3px;
}
header .muted {
  color: rgba(255,255,255,.85);
}
.h-row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }

/* Container */
.wrap { max-width: 1100px; margin: 0 auto; }

/* Buttons */
.btn {
  padding: 10px 14px;
  border-radius: 10px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  border: none;
  background: #fff;
  color: var(--text);
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}
.btn:hover { transform: translateY(-2px); box-shadow: var(--shadow); }
.btn.primary {
  background: linear-gradient(135deg, var(--primary), var(--accent));
  color: #fff;
  border: none;
}
.btn.primary:hover {
  box-shadow: 0 5px 15px rgba(37,99,235,0.3);
  transform: translateY(-2px);
}
.btn.alt {
  background: linear-gradient(135deg, #10b981, #059669);
  color: #fff;
}
.btn.ghost {
  background: transparent;
  border: 1px solid rgba(255,255,255,.4);
  color: #fff;
}
.chip {
  padding:6px 10px;
  border-radius: 8px;
  font-size: 13px;
  background:#e0e7ff;
  color:#1e3a8a;
  font-weight: 500;
}
.sep { width:1px; height:24px; background:rgba(255,255,255,0.3); }

/* Dropdown */
.dd { position: relative; }
.dd-btn { display:flex; align-items:center; gap:8px; background:#fff; border-radius:10px; border:none; padding:10px 12px; }
.dd-btn:hover { background:#f9fafb; }
.dd-menu {
  position:absolute; top:calc(100% + 8px); left:0;
  min-width:280px; background:#fff;
  border-radius:12px;
  box-shadow: var(--shadow-strong);
  padding:10px; display:none; z-index:30;
}
.dd.open .dd-menu { display:block; animation: fadeIn .2s ease; }
@keyframes fadeIn { from { opacity:0; transform:translateY(-6px);} to {opacity:1; transform:translateY(0);} }
.dd-item {
  padding:6px 8px; border-radius:8px;
  display:flex; align-items:center; gap:8px;
}
.dd-item:hover { background:#f3f4f6; }

/* Main & panels */
main { padding: 20px 18px; }
.panel {
  background: var(--card-bg);
  border-radius: var(--radius);
  padding: 18px;
  box-shadow: var(--shadow);
}

/* Quiz layout */
.quiz-shell {
  height: 72vh;
  display: grid;
  grid-template-rows: auto 1fr auto;
  gap: 16px;
  border-radius: 18px;
  background: linear-gradient(180deg, #fff, #f9fafb);
}
.quiz-scroll {
  overflow:auto;
  padding-right:6px;
  scroll-behavior: smooth;
}
.card {
  background: #fff;
  border-radius: 14px;
  box-shadow: var(--shadow);
  padding: 16px 18px;
  margin-bottom: 10px;
  border-left: 6px solid transparent;
  transition: border-color .3s;
}
.card:hover { border-color: var(--primary); transform: translateY(-1px); }

.q-head { font-weight: 700; font-size: 15px; }
.answer { display:flex; gap:10px; flex-wrap: wrap; align-items:center; }

/* Inputs */
input[type="text"], input[type="number"] {
  padding: 10px 12px;
  border:1px solid #d1d5db;
  border-radius:10px;
  font-size:14px;
  width: 220px;
}
input[type="text"]:focus, input[type="number"]:focus {
  border-color: var(--primary);
  outline:none;
  box-shadow: 0 0 0 3px rgba(37,99,235,.2);
}

/* Multiple-choice radio style */
.answer label {
  background:#f9fafb;
  padding:8px 10px;
  border-radius:10px;
  cursor:pointer;
  display:flex;
  align-items:center;
  gap:8px;
  font-size:14px;
  width:100%;
  border:1px solid #e5e7eb;
}
.answer label:hover { background:#e0f2fe; border-color:#93c5fd; }
.answer input[type=radio] { accent-color: var(--primary); width:16px; height:16px; }

/* Result pills */
.pill {
  font-size: 12px;
  padding: 4px 8px;
  border-radius:999px;
  background:#f1f5f9;
  border:1px solid #e5e7eb;
}
.ok { background:#dcfce7; color:#166534; border-color:#86efac; font-weight:600; }
.bad { background:#fee2e2; color:#991b1b; border-color:#fca5a5; font-weight:600; }

/* Reveal answer */
.muted { color: var(--muted); font-size:13px; }

/* Footer */
.footer {
  text-align:center;
  font-size:12px;
  color:#6b7280;
  margin-top:10px;
}

/* Modal */
.modal-backdrop {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.45);
  display:none;
  align-items:center;
  justify-content:center;
  z-index: 50;
}
.modal {
  width: min(720px, 92vw);
  background:#fff;
  border-radius:18px;
  overflow:hidden;
  box-shadow: var(--shadow-strong);
  animation: pop .25s ease;
}
@keyframes pop { from {transform:scale(.95); opacity:0;} to {transform:scale(1); opacity:1;} }
.modal header {
  background: linear-gradient(90deg, var(--primary), var(--accent));
  color:#fff;
  padding:14px 18px;
}
.modal .content { padding:18px; }

/* Animations & transitions */
.btn, .card, .answer label, input { transition: all 0.2s ease-in-out; }
/* === Sidebar ki·ªÉu Duolingo === */
/* Sidebar ki·ªÉu Duolingo hi·ªán ƒë·∫°i */
.sidebar {
  position: fixed;
  top: 0; left: 0;
  width: 260px;
  height: 100vh;
  background: linear-gradient(180deg, #ffffff, #f8fafc);
  border-right: 1px solid #e5e7eb;
  box-shadow: 2px 0 10px rgba(0,0,0,0.05);
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  padding: 20px 14px;
  z-index: 100;
}

.logo {
  font-weight: 900;
  font-size: 22px;
  color: #16a34a;
  text-align: center;
  margin-bottom: 12px;
}

.menu {
  display: flex;
  flex-direction: column;
  gap: 14px;
  overflow-y: auto;
  padding-right: 4px;
}

.group {
  display: grid;
  gap: 8px;
  background: #f9fafb;
  border-radius: 12px;
  padding: 10px 12px;
  border: 1px solid #f1f5f9;
}

.title {
  font-weight: 600;
  font-size: 13px;
  color: #374151;
  margin-bottom: 4px;
}

.btn.full {
  width: 100%;
  text-align: center;
  justify-content: center;
}

.btn.small {
  padding: 6px 8px;
  font-size: 13px;
}

.divider {
  height: 1px;
  border: none;
  background: #e5e7eb;
  margin: 10px 0;
}

.footer-mini {
  text-align: center;
  font-size: 12px;
  color: #9ca3af;
  margin-top: 10px;
}

/* D·ªãch ph·∫ßn main sang ph·∫£i ƒë·ªÉ ch·ª´a sidebar */
body {
  display: flex;
  flex-direction: row;
}
main {
  margin-left: 260px;
  width: calc(100% - 260px);
  padding: 24px;
}

/* FIX: Dropdown "Ch·ªçn b√†i" b·ªã ·∫©n trong sidebar */
/* ‚úÖ FIX dropdown ch·ªçn b√†i b·ªã che b·ªüi n·ªôi dung quiz */
/* ‚úÖ FIX CU·ªêI C√ôNG: Dropdown kh√¥ng b·ªã che b·ªüi quiz */
.sidebar {
  position: relative;
  z-index: 1000; /* ƒë·∫∑t sidebar n·ªïi cao h∆°n main */
  overflow: visible !important;
}

.dd {
  position: relative;
  z-index: 2000;
}

.dd-menu {
  position: absolute;
  left: 0;
  top: calc(100% + 8px);
  width: 240px;
  max-height: 400px;
  overflow-y: auto;
  background: #fff;
  border-radius: 12px;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
  z-index: 3000 !important; /* üî• cao h∆°n panel v√† quiz */
}

/* ƒê·∫£m b·∫£o quiz kh√¥ng che sidebar */
.quiz-shell, .panel, main {
  position: relative;
  z-index: 1;
}

/* ===== FIX dropdown ch·ªçn b√†i trong sidebar ===== */
.sidebar {
  overflow: visible !important;
}
.menu {
  overflow: visible !important;
}
.dd {
  position: relative;
  z-index: 9999;
}
.dd-menu {
  position: absolute;
  left: 0;
  top: calc(100% + 6px);
  max-height: 300px;
  overflow-y: auto;
  z-index: 99999;
  box-shadow: 0 8px 20px rgba(0,0,0,0.1);
}

/* Quiz t·ª´ng c√¢u */
.quiz-single {
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  height: 70vh;
  text-align: center;
}
.quiz-question {
  font-size: 20px;
  font-weight: 700;
  margin-bottom: 20px;
}
.quiz-options {
  display: grid;
  gap: 10px;
  width: min(400px, 90%);
}
.quiz-options label {
  background: #f9fafb;
  padding: 12px;
  border-radius: 12px;
  cursor: pointer;
  font-size: 16px;
  border: 1px solid #e5e7eb;
}
.quiz-options label:hover {
  background: #e0f2fe;
  border-color: #60a5fa;
}
.quiz-result {
  font-size: 18px;
  font-weight: 600;
  margin-top: 20px;
}


</style>

</head>
<body>

  <!-- Header -->
  <!-- Sidebar ch√≠nh thay cho header -->
<aside class="sidebar">
  <div class="logo">üçÄ Minna</div>

  <nav class="menu">
    <button class="btn primary full" id="btnData">üìÇ N·∫°p d·ªØ li·ªáu</button>
    <span class="chip" id="dataInfo">Ch∆∞a c√≥ d·ªØ li·ªáu</span>

    <hr class="divider"/>

    <div class="group">
      <label class="title">B√†i h·ªçc</label>
      <div class="dd" id="lessonDD">
        <button class="btn dd-btn" id="lessonBtn">Ch·ªçn b√†i (0)</button>
        <div class="dd-menu panel">
          <div class="dd-actions">
            <button class="btn small" id="checkAll">Ch·ªçn t·∫•t c·∫£</button>
            <button class="btn small" id="uncheckAll">B·ªè ch·ªçn</button>
            <span class="muted" id="countPick">0 b√†i</span>
          </div>
          <div class="dd-list" id="lessonList"></div>
        </div>
      </div>
    </div>

    <div class="group">
      <label class="title">T√πy ch·ªçn</label>
      <label class="chip"><input type="checkbox" id="direction"/> Vi·ªát ‚Üí Nh·∫≠t</label>
      <label class="chip"><input type="checkbox" id="furigana"/> Hi·ªán Kanji</label>
      <label class="chip"><input type="checkbox" id="shuffle" checked/> X√°o tr·ªôn</label>
      <label class="chip">S·ªë c√¢u: <input type="number" id="numQ" min="1" step="1" value="10" style="width:70px;margin-left:6px"/></label>
      <label class="chip"><input type="checkbox" id="multipleChoice"/> 4 ƒë√°p √°n ch·ªçn</label>
    </div>

    <div class="group">
      <button class="btn primary full" id="makeQuiz">üöÄ L√†m b√†i</button>
      <button class="btn full" id="clearQuiz">üóëÔ∏è X√≥a ƒë·ªÅ</button>
    </div>
  </nav>

  <footer class="footer-mini">¬© Minna 2025</footer>
</aside>


  <main class="wrap">
    <!-- Quiz fixed shell -->
    <section class="panel quiz-shell" id="quizShell" style="display:none">
      <div class="h-row" id="quizToolbar" style="justify-content:space-between">
        <div class="h-row">
          <div id="scoreBox" class="chip">ƒêi·ªÉm: <b id="scoreNow">0</b>/<span id="scoreMax">0</span></div>
          <div class="chip">ƒê√£ l√†m: <b id="doneNow">0</b>/<span id="doneMax">0</span></div>
        </div>
        <div class="h-row">
          <button class="btn alt" id="submitQuiz">Submit</button>
          <button class="btn" id="retryWrong" style="display:none">L√†m l·∫°i c√¢u sai</button>
          <button class="btn" id="retryAll" style="display:none">L√†m l·∫°i t·∫•t c·∫£</button>
        </div>
      </div>

      <div class="quiz-scroll" id="quiz"></div>

      <div class="footer">
        Ngu·ªìn tham kh·∫£o d·ªØ li·ªáu: VNJPClub ‚Äì Minna no Nihongo 1‚Äì50. D√πng cho m·ª•c ƒë√≠ch h·ªçc c√° nh√¢n.
      </div>
    </section>
  </main>

  <!-- Data Modal -->
  <div class="modal-backdrop" id="modalData">
    <div class="modal">
      <header style="padding:12px 16px; background:#fff">
        <div class="h-row" style="justify-content:space-between">
          <div><b>Qu·∫£n l√Ω d·ªØ li·ªáu 50 b√†i</b></div>
          <button class="btn" id="closeModal">ƒê√≥ng</button>
        </div>
      </header>
      <div class="content">
        <div class="panel">
          <div class="row">
            <label for="fileInput"><b>N·∫°p t·ª´ file JSON:</b></label>
            <input type="file" id="fileInput" accept=".json" />
            <button class="btn" id="clearData">X√≥a d·ªØ li·ªáu ƒë√£ n·∫°p</button>
          </div>
        </div>
        <div class="panel">
          <p class="muted">Ho·∫∑c d√°n JSON v√†o √¥ d∆∞·ªõi (c·∫•u tr√∫c: {"1":[{"jp":"„Çè„Åü„Åó","kanji":"ÁßÅ","vn":"t√¥i"}, ...]}; c√≥ th·ªÉ k√®m <code>synonymsVN</code>/<code>synonymsJP</code>)</p>
          <textarea id="jsonInput" rows="10" placeholder='{"1":[{"jp":"...", "kanji":"...", "vn":"..."}], "synonymsVN":[["b·∫©n","d∆°"]]}'></textarea>
          <div class="row">
            <button class="btn alt" id="loadJson">N·∫°p d·ªØ li·ªáu</button>
            <button class="btn" id="downloadJson">T·∫£i JSON hi·ªán t·∫°i</button>
          </div>
        </div>
      </div>
    </div>
  </div>

 <script>
  // ====== D·ªÆ LI·ªÜU trong b·ªô nh·ªõ (n·∫°p t·ª´ file/textarea) ======
  const DATA = {}; // { "1": [ {jp, kanji?, vn, alt?}, ... ], ... }
  const STORAGE_KEY = "minna_vocab_v1"; // üî• kh√≥a l∆∞u localStorage

  // ====== DOM ======
  const dataInfo = document.getElementById('dataInfo');

  const lessonDD = document.getElementById('lessonDD');
  const lessonBtn = document.getElementById('lessonBtn');
  const lessonList = document.getElementById('lessonList');
  const countPick = document.getElementById('countPick');

  const numQ = document.getElementById('numQ');
  const shuffleCB = document.getElementById('shuffle');
  const directionCB = document.getElementById('direction');
  const furiganaCB = document.getElementById('furigana');
  const multipleChoiceCB = document.getElementById('multipleChoice');


  const quizShell = document.getElementById('quizShell');
  const quizEl = document.getElementById('quiz');
  const scoreNow = document.getElementById('scoreNow');
  const scoreMax = document.getElementById('scoreMax');
  const doneNow = document.getElementById('doneNow');
  const doneMax = document.getElementById('doneMax');

  const submitQuizBtn = document.getElementById('submitQuiz');
  const retryWrongBtn = document.getElementById('retryWrong');
  const retryAllBtn = document.getElementById('retryAll');

  // Modal
  const modal = document.getElementById('modalData');
  const btnData = document.getElementById('btnData');
  const closeModal = document.getElementById('closeModal');
  const fileInput = document.getElementById('fileInput');
  const jsonInput = document.getElementById('jsonInput');

  // Buttons header
  const makeQuizBtn = document.getElementById('makeQuiz');
  const clearQuizBtn = document.getElementById('clearQuiz');
  const checkAllBtn = document.getElementById('checkAll');
  const uncheckAllBtn = document.getElementById('uncheckAll');

  // Data actions
  const loadJsonBtn = document.getElementById('loadJson');
  const downloadJsonBtn = document.getElementById('downloadJson');
  const clearDataBtn = document.getElementById('clearData');

  // ====== Utils (M·ªöI: chu·∫©n h√≥a + ƒë·ªìng nghƒ©a + fuzzy) ======
  const shuffleArr = (arr)=> arr.map(v=>[Math.random(), v]).sort((a,b)=>a[0]-b[0]).map(x=>x[1]);

  function stripNotes(s){
    return (s||'').replace(/[\[\(Ôºà][^\]\)Ôºâ]*[\]\)Ôºâ]/g, '');
  }
  function removeVNAccents(s){
    return (s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'');
  }
  const STOP_VN = new Set([
    "c√°i","chi·∫øc","con","b·ªô","t·∫•m","mi·∫øng","c√¢y","b·ª©c",
    "vi·ªác","s·ª±","ƒë·ªì","th·ª©","c√°i ƒë·ªì","chuy·ªán","ƒëi·ªÅu",
    "ng∆∞·ªùi","b·ªçn","c√°c","nh·ªØng"
  ]);
  function tokenizeVN(s){
    const t = removeVNAccents(stripNotes(s)).toLowerCase();
    return t.split(/[^a-z0-9]+/).filter(w=> w && !STOP_VN.has(w));
  }
  function normalizeVN_str(s){ return tokenizeVN(s).join(''); }
  function normalizeJP(s){ return stripNotes(s).replace(/\s+/g,'').toLowerCase(); }
  function isJapaneseOnly(s){
    const re = /^[\u3040-\u309F\u30A0-\u30FF\uFF65-\uFF9F\u4E00-\u9FFF\u30FC\u30FB\s]+$/;
    return re.test(s);
  }

  // ƒê·ªìng nghƒ©a (c√≥ th·ªÉ n·∫°p th√™m qua JSON)
  let VN_SYNONYM_GROUPS = [
    ["b·∫©n","d∆°","d∆° b·∫©n","d∆° d√°y"],
    ["th√πng r√°c","s·ªçt r√°c","th√πng r√°c th·∫£i"],
    ["ƒë·∫πp","xinh","d·ªÖ th∆∞∆°ng","ƒë√°ng y√™u"],
    ["toilet","nh√† v·ªá sinh","wc","nh√† x√≠"],
    ["gi·∫≠n","t·ª©c gi·∫≠n","b·ª±c m√¨nh","c√°u"],
  ];
  let JP_SYNONYM_GROUPS = []; // t√πy ch·ªçn

  function buildSynIndexVN(groups){ return groups.map(g => g.map(normalizeVN_str)); }
  function buildSynIndexJP(groups){ return groups.map(g => g.map(normalizeJP)); }
  let VN_GROUPS_NORM = buildSynIndexVN(VN_SYNONYM_GROUPS);
  let JP_GROUPS_NORM = buildSynIndexJP(JP_SYNONYM_GROUPS);

  function expandWithVNSynonyms(phrases){
    const set = new Set();
    const base = phrases ?? [];
    for (const p of base){
      const pn = normalizeVN_str(p);
      set.add(pn);
      for (const g of VN_GROUPS_NORM){
        if (g.includes(pn)) for (const alt of g) set.add(alt);
      }
    }
    return set;
  }
  function expandWithJPSynonyms(phrases){
    const set = new Set();
    const base = phrases ?? [];
    for (const p of base){
      const pn = normalizeJP(p);
      set.add(pn);
      for (const g of JP_GROUPS_NORM){
        if (g.includes(pn)) for (const alt of g) set.add(alt);
      }
    }
    return set;
  }
  function tokenSetEqualVN(a, b){
    const A = tokenizeVN(a).sort();
    const B = tokenizeVN(b).sort();
    if (A.length !== B.length) return false;
    for (let i=0;i<A.length;i++) if (A[i]!==B[i]) return false;
    return true;
  }
  function levenshtein(a,b){
    const m = a.length, n = b.length;
    if (!m) return n; if (!n) return m;
    const dp = Array.from({length:m+1},()=>Array(n+1).fill(0));
    for (let i=0;i<=m;i++) dp[i][0]=i;
    for (let j=0;j<=n;j++) dp[0][j]=j;
    for (let i=1;i<=m;i++){
      for (let j=1;j<=n;j++){
        const cost = a[i-1]===b[j-1] ? 0 : 1;
        dp[i][j] = Math.min(
          dp[i-1][j]+1,
          dp[i][j-1]+1,
          dp[i-1][j-1]+cost
        );
      }
    }
    return dp[m][n];
  }
  function fuzzyOK(user, target){
    const len = Math.max(user.length, target.length);
    const dist = levenshtein(user, target);
    const thr = len <= 4 ? 1 : 2;
    return dist <= thr;
  }

  // ====== Lessons UI ======
  function refreshLessonOptions(){
    lessonList.innerHTML = '';
    const keys = Object.keys(DATA).map(k=>Number(k)).sort((a,b)=>a-b);
    dataInfo.textContent = keys.length ? `ƒê√£ n·∫°p: ${keys.length} b√†i` : 'Ch∆∞a c√≥ d·ªØ li·ªáu';
    if (!keys.length){
      lessonBtn.textContent = 'Ch·ªçn b√†i (0)';
      countPick.textContent = '0 b√†i';
      return;
    }
    for (const k of keys){
      const id = `L${k}`;
      const item = document.createElement('label');
      item.className = 'dd-item';
      item.innerHTML = `<input type="checkbox" value="${k}" id="${id}"><span>B√†i ${k}</span>`;
      lessonList.appendChild(item);
    }
    updateLessonCount();
  }
  function getSelectedLessons(){
    return Array.from(lessonList.querySelectorAll('input[type=checkbox]:checked')).map(i=>i.value);
  }
  function setAllLessons(checked){
    lessonList.querySelectorAll('input[type=checkbox]').forEach(i=> i.checked = checked);
    updateLessonCount();
  }
  function updateLessonCount(){
    const n = getSelectedLessons().length;
    lessonBtn.textContent = `Ch·ªçn b√†i (${n})`;
    countPick.textContent = `${n} b√†i`;
  }
  lessonBtn.addEventListener('click', ()=>{ lessonDD.classList.toggle('open'); });
  document.addEventListener('click', (e)=>{ if (!lessonDD.contains(e.target)) lessonDD.classList.remove('open'); });
  lessonList.addEventListener('change', updateLessonCount);
  checkAllBtn.addEventListener('click', ()=> setAllLessons(true));
  uncheckAllBtn.addEventListener('click', ()=> setAllLessons(false));

  // ====== LocalStorage helpers ======
  function saveToLocal(){
    try { 
      const payload = { ...DATA, __synVN: VN_SYNONYM_GROUPS, __synJP: JP_SYNONYM_GROUPS };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(payload)); 
    }
    catch(e){ console.warn('L∆∞u localStorage l·ªói:', e); }
  }
  function loadFromLocal(){
    try {
      const s = localStorage.getItem(STORAGE_KEY);
      if (!s) return;
      const obj = JSON.parse(s);
      // kh√¥i ph·ª•c synonyms n·∫øu c√≥
      if (Array.isArray(obj.__synVN)) {
        VN_SYNONYM_GROUPS = obj.__synVN;
        VN_GROUPS_NORM = buildSynIndexVN(VN_SYNONYM_GROUPS);
        delete obj.__synVN;
      }
      if (Array.isArray(obj.__synJP)) {
        JP_SYNONYM_GROUPS = obj.__synJP;
        JP_GROUPS_NORM = buildSynIndexJP(JP_SYNONYM_GROUPS);
        delete obj.__synJP;
      }
      for (const k of Object.keys(obj)) DATA[k] = obj[k];
    } catch(e){ console.warn('ƒê·ªçc localStorage l·ªói:', e); }
  }
  function clearLocal(){
    try { localStorage.removeItem(STORAGE_KEY); } catch{}
  }

  // ====== Data merge / load (M·ªöI: nh·∫≠n synonymsVN/JP) ======
  function mergeData(obj){
    let added = 0;

    if (Array.isArray(obj.synonymsVN)){
      VN_SYNONYM_GROUPS = obj.synonymsVN;
      VN_GROUPS_NORM = buildSynIndexVN(VN_SYNONYM_GROUPS);
    }
    if (Array.isArray(obj.synonymsJP)){
      JP_SYNONYM_GROUPS = obj.synonymsJP;
      JP_GROUPS_NORM = buildSynIndexJP(JP_SYNONYM_GROUPS);
    }

    for (const k of Object.keys(obj)){
      if (k==="synonymsVN" || k==="synonymsJP") continue;
      DATA[k] = obj[k];
      added++;
    }
    refreshLessonOptions();
    saveToLocal(); // üî• l∆∞u ngay sau khi n·∫°p
    alert('ƒê√£ n·∫°p d·ªØ li·ªáu' + (added ? `: ${added} nh√≥m` : '') + (obj.synonymsVN||obj.synonymsJP ? ' (ƒë√£ c·∫≠p nh·∫≠t ƒë·ªìng nghƒ©a)' : ''));
  }

  fileInput.addEventListener('change', function(){
    const f = this.files[0]; if(!f) return;
    const reader = new FileReader();
    reader.onload = (e)=>{
      try { const obj = JSON.parse(e.target.result); mergeData(obj); }
      catch(err){ alert('File JSON kh√¥ng h·ª£p l·ªá: ' + err.message); }
    };
    reader.readAsText(f, 'utf-8');
  });
  loadJsonBtn.onclick = () => {
    try { const obj = JSON.parse(jsonInput.value); mergeData(obj); }
    catch (e) { alert('JSON kh√¥ng h·ª£p l·ªá: ' + e.message); }
  };
  downloadJsonBtn.onclick = () => {
    // l∆∞u c·∫£ synonyms v√†o file t·∫£i xu·ªëng
    const payload = { ...DATA, synonymsVN: VN_SYNONYM_GROUPS, synonymsJP: JP_SYNONYM_GROUPS };
    const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'minna50_vocab.json';
    a.click();
    URL.revokeObjectURL(a.href);
  };
  clearDataBtn.onclick = () => {
    for (const k of Object.keys(DATA)) delete DATA[k];
    VN_SYNONYM_GROUPS = [];
    JP_SYNONYM_GROUPS = [];
    VN_GROUPS_NORM = [];
    JP_GROUPS_NORM = [];
    refreshLessonOptions();
    clearLocal(); // üî• x√≥a lu√¥n d·ªØ li·ªáu ƒë√£ l∆∞u
    alert('ƒê√£ x√≥a d·ªØ li·ªáu trong b·ªô nh·ªõ.');
  };

  // ====== Build quiz pool ======
  function collectSelectedData() {
    const opts = getSelectedLessons();
    const pool = [];
    for (const L of opts) if (DATA[L]) pool.push(...DATA[L].map(x=> ({...x, lesson: Number(L)})));
    return pool;
  }

  // ====== Quiz lifecycle ======
  let currentPicked = []; // store picked questions for submit/retry
  let askVN = true;

  function checkAnswer(user, correct) {
  const u = (user || "").trim().toLowerCase();
  const c = (correct || "").trim().toLowerCase();
  if (!u) return false;
  if (u === c) return true;
  if (fuzzyOK(u, c)) return true;
  return false;
}

  function renderQuiz(picked) {
  quizEl.innerHTML = "";
  const N = picked.length;
  let current = 0;
  let answers = [];

  scoreNow.textContent = "0";
  scoreMax.textContent = String(N);
  doneNow.textContent = "0";
  doneMax.textContent = String(N);

  submitQuizBtn.style.display = "inline-block";
  retryWrongBtn.style.display = "none";
  retryAllBtn.style.display = "none";

  const showQuestion = () => {
    quizEl.innerHTML = "";
    // Khi h·∫øt c√¢u h·ªèi
    if (current >= N) {
      quizEl.innerHTML = `
        <div class='card'>
          <div class='q-head'>üéØ ƒê√£ ho√†n th√†nh ${N} c√¢u</div>
          <div class='muted'>Nh·∫•n <b>Submit</b> ƒë·ªÉ xem k·∫øt qu·∫£.</div>
        </div>`;
      return;
    }

    const it = picked[current];
    const card = document.createElement("div");
    card.className = "card";

    const head = document.createElement("div");
    head.className = "q-head";
    const qTxt = askVN
      ? it.vn
      : (furiganaCB.checked && it.kanji ? `${it.jp}Ôºà${it.kanji}Ôºâ` : it.jp);
    head.textContent = `${current + 1}. ${qTxt}`;
    card.appendChild(head);

    const ans = document.createElement("div");
    ans.className = "answer";

    // ==== 4 l·ª±a ch·ªçn ====
    if (multipleChoiceCB.checked) {
      const allItems = collectSelectedData();
      const correct = askVN ? it.jp : it.vn;
      const opts = [correct];
      const wrongs = shuffleArr(allItems)
        .filter(x => (askVN ? x.jp !== it.jp : x.vn !== it.vn))
        .slice(0, 3);
      wrongs.forEach(x => opts.push(askVN ? x.jp : x.vn));

      shuffleArr(opts).forEach(opt => {
        const lbl = document.createElement("label");
        const radio = document.createElement("input");
        radio.type = "radio";
        radio.name = "q";
        radio.value = opt;
        lbl.append(radio, opt);

       lbl.addEventListener("click", (e) => {
  // üß© NgƒÉn kh√¥ng cho s·ª± ki·ªán click c·ªßa input lan ra label l·∫ßn n·ªØa
  e.stopPropagation();
  if (answers[current]) return;

  answers[current] = { item: it, user: opt, correct };
  doneNow.textContent = answers.filter(Boolean).length;

  // ‚úÖ Kh√≥a t·∫°m input sau khi ch·ªçn ƒë·ªÉ kh√¥ng click l·∫°i
  Array.from(ans.querySelectorAll("input[type=radio]")).forEach(r => r.disabled = true);

  current++;
  setTimeout(showQuestion, 250);
});

        ans.appendChild(lbl);
      });
    }
    // ==== Nh·∫≠p ƒë√°p √°n (text) ====
    else {
      const input = document.createElement("input");
      input.type = "text";
      input.placeholder = askVN ? "Nh·∫≠p ti·∫øng Nh·∫≠t" : "Nh·∫≠p nghƒ©a ti·∫øng Vi·ªát";
      ans.appendChild(input);

      const btn = document.createElement("button");
      btn.className = "btn alt";
      btn.textContent = "Tr·∫£ l·ªùi";
      btn.addEventListener("click", () => {
        const val = input.value.trim();
        if (!val) return alert("Nh·∫≠p c√¢u tr·∫£ l·ªùi!");
        if (answers[current]) return;
        answers[current] = { item: it, user: val, correct: askVN ? it.jp : it.vn };
        doneNow.textContent = answers.filter(Boolean).length;
        current++;
        showQuestion();
      });
      ans.appendChild(btn);
    }

    card.appendChild(ans);
    quizEl.appendChild(card);
  };

  // ==== Khi nh·∫•n Submit ====
  submitQuizBtn.onclick = () => {
  // N·∫øu ch∆∞a l√†m h·∫øt th√¨ v·∫´n ch·∫•m ph·∫ßn ƒë√£ l√†m
  quizEl.innerHTML = "";
  let correctCount = 0;

  // N·∫øu answers r·ªóng => kh√¥ng c√≥ c√¢u n√†o ƒë√£ ch·ªçn
  if (!answers.length) {
    quizEl.innerHTML = `<div class="card"><b>Ch∆∞a c√≥ c√¢u tr·∫£ l·ªùi n√†o!</b></div>`;
    return;
  }

  const validAnswers = answers.filter(Boolean);
  validAnswers.forEach((a, i) => {
    const card = document.createElement("div");
    card.className = "card";

    const qHead = document.createElement("div");
    qHead.className = "q-head";
    const qTxt = askVN
      ? a.item.vn
      : (furiganaCB.checked && a.item.kanji ? `${a.item.jp}Ôºà${a.item.kanji}Ôºâ` : a.item.jp);
    qHead.textContent = `${i + 1}. ${qTxt}`;
    card.appendChild(qHead);

    const ok = checkAnswer(a.user, a.correct);
    if (ok) correctCount++;

    const status = document.createElement("span");
    status.className = ok ? "pill ok" : "pill bad";
    status.textContent = ok ? "ƒê√∫ng" : "Sai";

    const reveal = document.createElement("div");
    reveal.className = "muted";
    reveal.innerHTML = `
      <div>Tr·∫£ l·ªùi: <b>${a.user || "(b·ªè tr·ªëng)"}</b></div>
      <div>ƒê√°p √°n: <b>${a.correct}</b></div>`;

    card.append(status, reveal);
    quizEl.appendChild(card);
  });

  scoreNow.textContent = String(correctCount);
  retryWrongBtn.style.display = "inline-block";
  retryAllBtn.style.display = "inline-block";
  lastAnswers = validAnswers;
  lastPool = picked;
};


  showQuestion();
}






  // ====== CH·∫§M ƒêI·ªÇM (M·ªöI: ƒë·ªìng nghƒ©a + token-set + fuzzy) ======
  function gradeQuiz(){
  const cards = Array.from(quizEl.querySelectorAll('.card'));
  let correctCount = 0;

  cards.forEach((card, i)=>{
    const item = currentPicked[i];
    const status = card.querySelector('.pill:last-child');
    const reveal = card.querySelector('.muted');
    reveal.style.display = '';

    if (multipleChoiceCB.checked){
      // Ch·∫•m ki·ªÉu ch·ªçn
      const radios = card.querySelectorAll('input[type=radio]');
      let chosen = '';
      radios.forEach(r => { if (r.checked) chosen = r.value.trim(); });
      const correct = askVN ? item.jp : item.vn;
      if (!chosen){
        status.textContent = 'Ch∆∞a tr·∫£ l·ªùi'; status.className = 'pill bad';
      } else if (chosen === correct){
        correctCount++; status.textContent = 'ƒê√∫ng'; status.className = 'pill ok';
      } else {
        status.textContent = 'Sai'; status.className = 'pill bad';
      }
      radios.forEach(r => r.disabled = true);
    } else {
      // Gi·ªØ logic ch·∫•m text nh∆∞ c≈©
      const inp = card.querySelector('input[type=text]');
      const raw = inp.value.trim();
      if (!raw){
        status.textContent = 'Ch∆∞a tr·∫£ l·ªùi'; status.className = 'pill bad';
        inp.disabled = true; return;
      }

      if (directionCB.checked){
        const userN = normalizeJP(raw);
        const baseJP = [item.jp, item.kanji].filter(Boolean);
        const accept = expandWithJPSynonyms(baseJP);
        let ok = false;
        for (const cand of accept){
          if (userN===cand || fuzzyOK(userN, cand)){ ok = true; break; }
        }
        if (ok){ correctCount++; status.textContent='ƒê√∫ng'; status.className='pill ok'; }
        else { status.textContent='Sai'; status.className='pill bad'; }
      } else {
        const userStr = normalizeVN_str(raw);
        const acceptSet = expandWithVNSynonyms([item.vn]);
        let ok = false;
        for (const cand of acceptSet){
          if (userStr===cand || fuzzyOK(userStr, cand)){ ok = true; break; }
        }
        if (ok){ correctCount++; status.textContent='ƒê√∫ng'; status.className='pill ok'; }
        else { status.textContent='Sai'; status.className='pill bad'; }
      }
      inp.disabled = true;
    }
  });

  scoreNow.textContent = String(correctCount);
  retryWrongBtn.style.display = 'inline-block';
  retryAllBtn.style.display = 'inline-block';
}


function makeQuiz() {
  let pool = collectSelectedData();
  if (pool.length === 0) {
    alert('Ch∆∞a c√≥ d·ªØ li·ªáu cho b√†i ƒë√£ ch·ªçn. H√£y n·∫°p JSON tr∆∞·ªõc.');
    return;
  }

  // ‚úÖ L·ªçc tr√πng (theo jp ho·∫∑c vn t√πy h∆∞·ªõng)
  const seen = new Set();
  const uniquePool = [];
  for (const item of pool) {
    const key = directionCB.checked
      ? (item.jp || item.kanji || "").trim().toLowerCase()
      : (item.vn || "").trim().toLowerCase();
    if (!seen.has(key)) {
      seen.add(key);
      uniquePool.push(item);
    }
  }

  // ‚úÖ X√°o tr·ªôn
  if (shuffleCB.checked) uniquePool.sort(() => Math.random() - 0.5);

  // ‚úÖ L·∫•y s·ªë l∆∞·ª£ng c√¢u h·ª£p l·ªá
  const N = Math.max(1, Math.min(uniquePool.length, parseInt(numQ.value || '10', 10)));
  askVN = directionCB.checked;

  // ‚úÖ Ch·ªçn ng·∫´u nhi√™n kh√¥ng tr√πng
  const selected = [];
  const used = new Set();
  while (selected.length < N && uniquePool.length > 0) {
    const idx = Math.floor(Math.random() * uniquePool.length);
    const q = uniquePool[idx];
    const key = askVN ? q.vn : q.jp;
    if (!used.has(key)) {
      used.add(key);
      selected.push(q);
    }
    uniquePool.splice(idx, 1); // x√≥a kh·ªèi pool ƒë·ªÉ tr√°nh tr√πng
  }

  currentPicked = selected;
  lastPool = [...selected];

  scoreNow.textContent = "0";
  doneNow.textContent = "0";

  submitQuizBtn.style.display = "inline-block";
  retryWrongBtn.style.display = "none";
  retryAllBtn.style.display = "none";

  quizShell.style.display = '';
  renderQuiz(currentPicked);
}



// Khi quiz ho√†n t·∫•t (ƒë∆∞·ª£c g·ªçi trong renderQuiz)
function showRetryButtons() {
  retryWrongBtn.style.display = 'inline-block';
  retryAllBtn.style.display = 'inline-block';
}

  function retryWrong() {
  const wrong = currentPicked.filter((_, i) => {
    const a = document.querySelectorAll('.card .pill.bad')[i];
    return a !== undefined;
  });
  if (!wrong.length) {
    alert('B·∫°n kh√¥ng c√≤n c√¢u sai üéâ');
    return;
  }
  currentPicked = shuffleArr(wrong);
  renderQuiz(currentPicked);
}

  function retryAll(){
    currentPicked = shuffleArr(currentPicked);
    renderQuiz(currentPicked);
    retryWrongBtn.style.display = 'none';
    retryAllBtn.style.display = 'none';
  }

  // ====== Events ======
  makeQuizBtn.addEventListener('click', makeQuiz);
  clearQuizBtn.addEventListener('click', ()=>{ quizEl.innerHTML=''; quizShell.style.display='none'; });
  
  retryWrongBtn.addEventListener('click', retryWrong);
  retryAllBtn.addEventListener('click', retryAll);

  // ====== Modal open/close ======
  function openModal(){ modal.style.display = 'flex'; }
  function closeModalFn(){ modal.style.display = 'none'; }
  btnData.addEventListener('click', openModal);
  closeModal.addEventListener('click', closeModalFn);
  modal.addEventListener('click', (e)=>{ if (e.target === modal) closeModalFn(); });

  // ====== Kh·ªüi ƒë·ªông: kh√¥i ph·ª•c d·ªØ li·ªáu ƒë√£ l∆∞u (n·∫øu c√≥) ======
  window.addEventListener('DOMContentLoaded', ()=>{
    loadFromLocal();        // üî• kh√¥i ph·ª•c
    refreshLessonOptions(); // v·∫Ω l·∫°i danh s√°ch b√†i
  });
</script>
</body>
</html> 
